<%# Renders a Chart.js plot from WORKFLOW_PLOTS data %>
<%# Usage: render "shared/plot", plot_id: "eda_histogram" %>
<% plot = WORKFLOW_PLOTS[plot_id] rescue nil %>
<% if plot %>
  <div class="plot-container">
    <div class="plot-title"><%= plot[:title] %></div>
    <% if plot[:type] == "heatmap_table" %>
      <%# Render as styled HTML table %>
      <div class="plot-heatmap">
        <table>
          <thead>
            <tr>
              <th></th>
              <% plot[:data][:labels].each do |l| %><th><%= l %></th><% end %>
            </tr>
          </thead>
          <tbody>
            <% row_labels = plot[:data][:row_labels] || plot[:data][:labels] %>
            <% plot[:data][:matrix].each_with_index do |row, i| %>
              <tr>
                <th><%= row_labels[i] %></th>
                <% row.each do |val| %>
                  <% intensity = (val.abs * 255).clamp(0, 255).to_i %>
                  <% color = val >= 0 ? "rgba(34,197,94,#{val.abs * 0.7})" : "rgba(239,68,68,#{val.abs * 0.7})" %>
                  <td style="background: <%= color %>; color: white; font-weight: 600;">
                    <%= val.is_a?(Float) ? ("%.2f" % val) : val %>
                  </td>
                <% end %>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    <% else %>
      <canvas id="chart-<%= plot_id %>" height="260"></canvas>
    <% end %>
    <% if plot[:options][:annotation] %>
      <div class="plot-annotation">ðŸ’¡ <%= plot[:options][:annotation] %></div>
    <% end %>
  </div>

  <% unless plot[:type] == "heatmap_table" %>
    <script>
    (function() {
      const ctx = document.getElementById('chart-<%= plot_id %>').getContext('2d');
      const plotData = <%= plot[:data].to_json.html_safe %>;
      const plotType = '<%= plot[:type] %>';
      const opts = <%= plot[:options].to_json.html_safe %>;

      let chartType = plotType;
      let chartData = plotData;
      let chartOptions = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { labels: { color: 'rgba(255,255,255,0.7)', font: { size: 11 } } },
        },
        scales: {
          x: {
            ticks: { color: 'rgba(255,255,255,0.5)', font: { size: 10 } },
            grid: { color: 'rgba(255,255,255,0.06)' },
            title: opts.scales_x ? { display: true, text: opts.scales_x, color: 'rgba(255,255,255,0.5)' } : {}
          },
          y: {
            ticks: { color: 'rgba(255,255,255,0.5)', font: { size: 10 } },
            grid: { color: 'rgba(255,255,255,0.06)' },
            title: opts.scales_y ? { display: true, text: opts.scales_y, color: 'rgba(255,255,255,0.5)' } : {}
          }
        }
      };

      if (plotType === 'bar_horizontal') {
        chartType = 'bar';
        chartOptions.indexAxis = 'y';
      }

      if (plotType === 'scatter') {
        chartType = 'scatter';
      }

      if (plotType === 'boxplot_custom') {
        chartType = 'bar';
      }

      new Chart(ctx, { type: chartType, data: chartData, options: chartOptions });
    })();
    </script>
  <% end %>
<% end %>
