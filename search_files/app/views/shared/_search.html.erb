<!-- Search trigger button in nav -->
<button class="search-trigger" id="searchTrigger" aria-label="Rechercher">
  <span class="search-trigger-icon">üîç</span>
  <span class="search-trigger-text">Rechercher...</span>
  <kbd class="search-trigger-kbd">‚åòK</kbd>
</button>

<!-- Search modal overlay -->
<div class="search-overlay" id="searchOverlay">
  <div class="search-modal" id="searchModal">
    <div class="search-input-wrap">
      <span class="search-input-icon">üîç</span>
      <input type="text" id="searchInput" placeholder="Rechercher un workflow, terme, m√©thode..." autocomplete="off" autofocus>
      <kbd class="search-esc" id="searchEsc">Esc</kbd>
    </div>
    <div class="search-results" id="searchResults">
      <div class="search-empty" id="searchEmpty">
        <p>Tapez pour chercher dans les workflows, le glossaire et les m√©thodes ML</p>
      </div>
    </div>
  </div>
</div>

<script>
(function() {
  const trigger = document.getElementById('searchTrigger');
  const overlay = document.getElementById('searchOverlay');
  const modal = document.getElementById('searchModal');
  const input = document.getElementById('searchInput');
  const results = document.getElementById('searchResults');
  const empty = document.getElementById('searchEmpty');
  let debounceTimer;

  function openSearch() {
    overlay.classList.add('open');
    document.body.style.overflow = 'hidden';
    input.value = '';
    results.innerHTML = '';
    empty.style.display = '';
    results.appendChild(empty);
    setTimeout(() => input.focus(), 100);
  }

  function closeSearch() {
    overlay.classList.remove('open');
    document.body.style.overflow = '';
  }

  // Open
  trigger.addEventListener('click', openSearch);

  // Close
  overlay.addEventListener('click', (e) => {
    if (e.target === overlay) closeSearch();
  });
  document.getElementById('searchEsc').addEventListener('click', closeSearch);

  // Cmd+K / Ctrl+K
  document.addEventListener('keydown', (e) => {
    if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
      e.preventDefault();
      openSearch();
    }
    if (e.key === 'Escape') closeSearch();
  });

  // Search with debounce
  input.addEventListener('input', () => {
    clearTimeout(debounceTimer);
    const q = input.value.trim();
    if (q.length < 2) {
      results.innerHTML = '';
      empty.style.display = '';
      results.appendChild(empty);
      return;
    }
    debounceTimer = setTimeout(() => doSearch(q), 150);
  });

  // Keyboard navigation
  let selectedIdx = -1;
  input.addEventListener('keydown', (e) => {
    const items = results.querySelectorAll('.search-result');
    if (e.key === 'ArrowDown') {
      e.preventDefault();
      selectedIdx = Math.min(selectedIdx + 1, items.length - 1);
      updateSelection(items);
    } else if (e.key === 'ArrowUp') {
      e.preventDefault();
      selectedIdx = Math.max(selectedIdx - 1, 0);
      updateSelection(items);
    } else if (e.key === 'Enter' && selectedIdx >= 0 && items[selectedIdx]) {
      e.preventDefault();
      items[selectedIdx].click();
    }
  });

  function updateSelection(items) {
    items.forEach((item, i) => {
      item.classList.toggle('selected', i === selectedIdx);
    });
  }

  function doSearch(q) {
    fetch('/recherche.json?q=' + encodeURIComponent(q))
      .then(r => r.json())
      .then(data => {
        selectedIdx = -1;
        if (data.length === 0) {
          results.innerHTML = '<div class="search-no-results">Aucun r√©sultat pour ¬´ ' + q + ' ¬ª</div>';
          return;
        }
        results.innerHTML = data.map((r, i) => {
          const typeClass = r.type === 'workflow' ? 'sr-workflow' : r.type === 'glossaire' ? 'sr-glossaire' : 'sr-methode';
          return '<a href="' + r.url + '" class="search-result ' + typeClass + '" onclick="closeSearchModal()">' +
            '<span class="sr-icon">' + r.icon + '</span>' +
            '<div class="sr-content">' +
              '<div class="sr-title">' + highlight(r.title, q) + '</div>' +
              '<div class="sr-subtitle">' + highlight(r.subtitle, q) + '</div>' +
            '</div>' +
            '<span class="sr-type">' + r.type + '</span>' +
          '</a>';
        }).join('');
      })
      .catch(() => {
        results.innerHTML = '<div class="search-no-results">Erreur de recherche</div>';
      });
  }

  function highlight(text, q) {
    if (!text) return '';
    const regex = new RegExp('(' + q.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + ')', 'gi');
    return text.replace(regex, '<mark>$1</mark>');
  }

  // Global close function for onclick
  window.closeSearchModal = closeSearch;
})();
</script>
